# Supabase Reservations MCP Server

This repository contains a [Model Context Protocol (MCP)](https://modelcontextprotocol.io/introduction) server that lets an LLM create, update, and delete restaurant reservations stored in Supabase. The worker runs on Cloudflare Durable Objects and exposes the `/mcp` transport so any MCP-compatible client can connect.

## Key Features

- **Supabase-backed tools** – Purpose-built MCP tools for creating, updating, and deleting reservations through the Supabase REST API.
- **Cloudflare Workers deployment** – Durable Objects keep the MCP session alive and run close to your users.
- **Optional Sentry instrumentation** – A second entry point (`src/index_sentry.ts`) wraps every tool in Sentry spans for production observability.
- **Inspector friendly** – Works out of the box with the MCP Inspector for manual testing.

## Project Structure

- `src/index.ts` – Main Durable Object entry point without authentication.
- `src/index_sentry.ts` – Variant with Sentry tracing enabled.
- `src/tools/` – MCP tool definitions and the Supabase service helper.
- `tests/` – Vitest unit coverage for the reservation tools.

## Prerequisites

- Node.js 18 or later
- A Cloudflare account with Wrangler installed (`npm install -g wrangler`)
- A Supabase project with a `reservations` table exposed through the REST API

## Environment Variables

Create a `.dev.vars` file by copying the example:

```bash
cp .dev.vars.example .dev.vars
```

Populate the values with your Supabase project details:

```bash
SUPABASE_URL=https://your-project.supabase.co
SUPABASE_SERVICE_ROLE_KEY=your_service_role_key
SENTRY_DSN=https://your-sentry-dsn@sentry.io/project-id # optional
NODE_ENV=development
```

The service role key must have permissions to read and write to the `reservations` table.

## Local Development

1. Install dependencies:

   ```bash
   npm install
   ```

2. Start the worker locally (defaults to port `8793`):

   ```bash
   wrangler dev
   ```

3. Open the [MCP Inspector](https://github.com/modelcontextprotocol/inspector) against the running worker:

   ```bash
   npx @modelcontextprotocol/inspector@latest http://localhost:8793/mcp
   ```

   Use the Inspector UI to call the `createReservation`, `updateReservation`, and `deleteReservation` tools.

## Deploying to Cloudflare Workers

1. Authenticate Wrangler with your Cloudflare account if you have not already:

   ```bash
   wrangler login
   ```

2. Configure your Supabase credentials as Worker secrets (they are also accepted as plain-text vars if you prefer):

   ```bash
   wrangler secret put SUPABASE_URL
   wrangler secret put SUPABASE_SERVICE_ROLE_KEY
   # Optional
   wrangler secret put SENTRY_DSN
   ```

3. Deploy the worker:

   ```bash
   npm run deploy
   ```

4. Test the deployed endpoint with the MCP Inspector by pointing it to your worker URL:

   ```bash
   npx @modelcontextprotocol/inspector@latest https://<your-worker-subdomain>.workers.dev/mcp
   ```

## Database Schema

Create a `reservations` table similar to the following:

```sql
create table if not exists reservations (
  id bigint generated by default as identity primary key,
  mobile text not null,
  name text not null,
  nb_people integer not null,
  email text,
  date date not null,
  time time not null,
  notes text,
  inserted_at timestamp with time zone default timezone('utc', now())
);
```

Feel free to add indexes or triggers that match your application's needs.

## Optional Sentry Variant

If you want request tracing and error reporting, deploy `src/index_sentry.ts` instead of the default entry point. Update `wrangler.jsonc` to set `"main": "src/index_sentry.ts"` before running `wrangler deploy`. The tool registration logic is identical, but each call is wrapped with Sentry spans and automatic error capture.

## Simple Math Example

For a lightweight example of an MCP worker without Supabase integration, run the bundled math server:

```bash
wrangler dev --config wrangler-simple.jsonc
```

It exposes a single `calculate` tool over `/mcp` and `/sse` that supports addition, subtraction, multiplication, and division.

## Testing

Run the Vitest suite locally:

```bash
npm test
```

The tests mock Supabase responses to verify that each reservation tool returns clear success or error messages.
